name: Databricks Deployment

on:
  push:
    branches:
      - Dev
      - main

jobs:
  deploy-Dev:
    if: github.ref == 'refs/heads/Dev'
    runs-on: self-hosted
    steps:
      # Step 1: Check if Databricks CLI is installed
      - name: Check if Databricks CLI is installed
        id: check-databricks-cli
        run: |
          if (-not (Get-Command databricks -ErrorAction SilentlyContinue)) {
            Write-Host "Databricks CLI not found. Installing Databricks CLI..."
            echo "cli_installed=false" >> $env:GITHUB_ENV
          } else {
            Write-Host "Databricks CLI is already installed."
            echo "cli_installed=true" >> $env:GITHUB_ENV
          }

      # Step 2: Install Databricks CLI if not installed
      - name: Install Databricks CLI
        if: env.cli_installed == 'false'
        run: |
          Write-Host "Installing Databricks CLI..."
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Output "Installing Chocolatey..."
            Set-ExecutionPolicy Bypass -Scope Process -Force; `
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; `
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          choco --version
          Write-Output "Installing Databricks CLI using Chocolatey..."
          choco install databricks-cli -y
          databricks --version
          Write-Host "Databricks CLI has been installed successfully."
